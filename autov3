-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

-- Variables
local attackEnabled = false
local attackCount = 10
local bringEnabled = false
local bringDistance = 5
local hitboxEnabled = false
local hitboxSize = 10
local reachEnabled = false
local whitelistNames = {}
local originalSizes = {}

-- Window
local Window = Rayfield:CreateWindow({
    Name = "‚öîÔ∏è Combat Suite v3",
    LoadingTitle = "Combat Suite v3",
    LoadingSubtitle = "Ultimate Fix",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false
})

----------------------------------------------
-- UTILITY
----------------------------------------------

local function getChar()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

local function getHRP()
    local c = getChar()
    return c and c:FindFirstChild("HumanoidRootPart")
end

local function isWhitelisted(name)
    for _, n in ipairs(whitelistNames) do
        if string.lower(n) == string.lower(name) then return true end
    end
    return false
end

local function isAlive(player)
    if not player then return false end
    local char = player.Character
    if not char then return false end
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return false end
    if hum.Health <= 0 then return false end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    return true
end

local function getAliveEnemies()
    local enemies = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and not isWhitelisted(player.Name) and isAlive(player) then
            table.insert(enemies, player)
        end
    end
    return enemies
end

-- ·∫®n x√°c ch·∫øt ho√†n to√†n
local function hideDeadBody(player)
    pcall(function()
        local char = player.Character
        if not char then return end
        local hum = char:FindFirstChildOfClass("Humanoid")
        if not hum or hum.Health <= 0 then
            for _, part in ipairs(char:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                    part.CanQuery = false
                    part.CanTouch = false
                    part.Transparency = 1
                    part.Size = Vector3.new(0.01, 0.01, 0.01)
                end
            end
        end
    end)
end

local function getWeaponArgs()
    local char = getChar()
    if not char then return nil end
    local blade = char:FindFirstChild("Crimson Blade")
    if not blade then return nil end
    local handle = blade:FindFirstChild("Handle")
    if not handle then return nil end
    local s = handle:FindFirstChild("Swing")
    local h = handle:FindFirstChild("HitSound")
    local a = handle:FindFirstChild("AttachmentDmgNum")
    local hl = blade:FindFirstChild("Highlight")
    if not (s and h and a and hl) then return nil end
    return s, h, a, hl
end

local function getRemote()
    local we = ReplicatedStorage:FindFirstChild("WeaponEvents")
    if not we then return nil end
    return we:FindFirstChild("CrimsonBladeAttack")
end

----------------------------------------------
-- AUTO ATTACK (X l·∫ßn m·ªói 0.01s)
----------------------------------------------

local attackThread = nil

local function startAttack()
    if attackThread then
        pcall(function() task.cancel(attackThread) end)
        attackThread = nil
    end

    attackThread = task.spawn(function()
        while true do
            if attackEnabled then
                local remote = getRemote()
                local s, h, a, hl = getWeaponArgs()
                if remote and s then
                    for i = 1, attackCount do
                        if not attackEnabled then break end
                        pcall(function()
                            remote:FireServer(s, h, a, hl)
                        end)
                    end
                end
            end
            task.wait(0.01)
        end
    end)
end

----------------------------------------------
-- BRING (ch·ªâ bring ng∆∞·ªùi S·ªêNG, ·∫©n x√°c ch·∫øt)
----------------------------------------------

local bringConnection = nil

local function startBring()
    if bringConnection then bringConnection:Disconnect() end

    bringConnection = RunService.Heartbeat:Connect(function()
        if not bringEnabled then return end

        local myHRP = getHRP()
        if not myHRP then return end
        local myChar = getChar()
        if not myChar then return end

        local lookVector = myHRP.CFrame.LookVector
        local targetPos = myHRP.Position + lookVector * bringDistance

        -- ·∫®n x√°c ch·∫øt tr∆∞·ªõc
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                if not isAlive(player) then
                    hideDeadBody(player)
                end
            end
        end

        -- Ch·ªâ bring ng∆∞·ªùi S·ªêNG
        local enemies = getAliveEnemies()
        for _, enemy in ipairs(enemies) do
            pcall(function()
                local enemyChar = enemy.Character
                local enemyHRP = enemyChar:FindFirstChild("HumanoidRootPart")
                if not enemyHRP then return end

                -- T·∫Øt collision enemy
                for _, part in ipairs(enemyChar:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end

                enemyHRP.CFrame = CFrame.new(targetPos)
                enemyHRP.Velocity = Vector3.zero
                enemyHRP.AssemblyLinearVelocity = Vector3.zero
                enemyHRP.AssemblyAngularVelocity = Vector3.zero
            end)
        end

        -- Gi·ªØ collision b·∫°n
        pcall(function()
            for _, part in ipairs(myChar:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                end
            end
        end)
    end)
end

----------------------------------------------
-- HITBOX (CH·ªà enemy s·ªëng, KH√îNG hitbox b·∫°n, ·∫©n x√°c)
----------------------------------------------

local hitboxConnection = nil

local function clearHitboxes()
    for player, data in pairs(originalSizes) do
        pcall(function()
            if player.Character then
                local root = player.Character:FindFirstChild("HumanoidRootPart")
                if root then
                    root.Size = data.size
                    root.Transparency = data.transparency
                    root.CanCollide = data.canCollide
                    root.Massless = false
                end
                -- Restore t·∫•t c·∫£ parts
                for _, part in ipairs(player.Character:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = true
                        part.CanQuery = true
                        part.CanTouch = true
                    end
                end
            end
        end)
    end
    originalSizes = {}
end

local function startHitbox()
    if hitboxConnection then hitboxConnection:Disconnect() end

    hitboxConnection = RunService.Heartbeat:Connect(function()
        if not hitboxEnabled then return end

        local myChar = getChar()
        if not myChar then return end

        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then -- B·ªé QUA B·∫†N HO√ÄN TO√ÄN
                pcall(function()
                    local enemyChar = player.Character
                    if not enemyChar then return end

                    local hum = enemyChar:FindFirstChildOfClass("Humanoid")
                    if not hum then return end

                    local enemyHRP = enemyChar:FindFirstChild("HumanoidRootPart")
                    if not enemyHRP then return end

                    -- NG∆Ø·ªúI CH·∫æT ‚Üí ·∫©n ho√†n to√†n, thu nh·ªè
                    if hum.Health <= 0 then
                        -- X√≥a kh·ªèi saved n·∫øu c√≥
                        if originalSizes[player] then
                            originalSizes[player] = nil
                        end

                        -- ·∫®n x√°c
                        for _, part in ipairs(enemyChar:GetDescendants()) do
                            if part:IsA("BasePart") then
                                part.Size = Vector3.new(0.01, 0.01, 0.01)
                                part.Transparency = 1
                                part.CanCollide = false
                                part.CanQuery = false
                                part.CanTouch = false
                            end
                        end
                        return
                    end

                    -- NG∆Ø·ªúI S·ªêNG + KH√îNG WHITELIST ‚Üí expand hitbox
                    if isWhitelisted(player.Name) then return end

                    -- L∆∞u original l·∫ßn ƒë·∫ßu
                    if not originalSizes[player] then
                        originalSizes[player] = {
                            size = enemyHRP.Size,
                            transparency = enemyHRP.Transparency,
                            canCollide = enemyHRP.CanCollide
                        }
                    end

                    enemyHRP.Size = Vector3.new(hitboxSize, hitboxSize, hitboxSize)
                    enemyHRP.Transparency = 0.6
                    enemyHRP.CanCollide = false
                    enemyHRP.Massless = true
                    enemyHRP.CanQuery = true
                    enemyHRP.CanTouch = true

                    -- T·∫Øt collision t·∫•t c·∫£ parts enemy
                    for _, part in ipairs(enemyChar:GetDescendants()) do
                        if part:IsA("BasePart") and part ~= enemyHRP then
                            part.CanCollide = false
                        end
                    end
                end)
            end
        end

        -- B·∫¢O V·ªÜ NH√ÇN V·∫¨T B·∫†N - KH√îNG BAO GI·ªú THAY ƒê·ªîI
        pcall(function()
            if myChar then
                for _, part in ipairs(myChar:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = true
                    end
                end
            end
        end)
    end)
end

----------------------------------------------
-- INFINITE REACH (firetouchinterest, ch·ªâ ng∆∞·ªùi s·ªëng)
----------------------------------------------

local reachConnection = nil

local function startReach()
    if reachConnection then reachConnection:Disconnect() end

    reachConnection = RunService.Heartbeat:Connect(function()
        if not reachEnabled then return end

        local char = getChar()
        if not char then return end

        local blade = char:FindFirstChild("Crimson Blade")
        if not blade then return end

        local handle = blade:FindFirstChild("Handle")
        if not handle then return end

        local touchInterest = handle:FindFirstChildOfClass("TouchInterest")
        if not touchInterest then return end

        local enemies = getAliveEnemies()

        for _, enemy in ipairs(enemies) do
            pcall(function()
                local enemyChar = enemy.Character
                if not enemyChar then return end

                for _, part in ipairs(enemyChar:GetChildren()) do
                    if part:IsA("BasePart") then
                        firetouchinterest(handle, part, 0)
                        task.defer(function()
                            pcall(function()
                                firetouchinterest(handle, part, 1)
                            end)
                        end)
                    end
                end
            end)
        end
    end)
end

----------------------------------------------
-- DEAD BODY CLEANER (ch·∫°y li√™n t·ª•c)
----------------------------------------------

local cleanerConnection = nil

local function startDeadCleaner()
    if cleanerConnection then cleanerConnection:Disconnect() end

    cleanerConnection = RunService.Heartbeat:Connect(function()
        -- Ch·ªâ ch·∫°y khi bring ho·∫∑c hitbox b·∫≠t
        if not bringEnabled and not hitboxEnabled then return end

        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and not isAlive(player) then
                hideDeadBody(player)
            end
        end
    end)
end

startDeadCleaner()

----------------------------------------------
-- UI TABS
----------------------------------------------

-- ========== ATTACK ==========
local AttackTab = Window:CreateTab("‚öîÔ∏è Attack", 4483362458)

AttackTab:CreateToggle({
    Name = "Auto Attack",
    CurrentValue = false,
    Flag = "AutoAttack",
    Callback = function(v)
        attackEnabled = v
        if v then startAttack() end
    end
})

AttackTab:CreateSlider({
    Name = "Hits per 0.01s",
    Range = {10, 40},
    Increment = 1,
    Suffix = " hits",
    CurrentValue = 10,
    Flag = "AttackCount",
    Callback = function(v) attackCount = v end
})

AttackTab:CreateParagraph({
    Title = "‚ÑπÔ∏è Info",
    Content = "M·ªói 0.01s fire remote X l·∫ßn.\n40 hits/0.01s = 4000 hits/gi√¢y.\nT·ª± reconnect sau die."
})

-- ========== BRING ==========
local BringTab = Window:CreateTab("üß≤ Bring", 4483362458)

BringTab:CreateToggle({
    Name = "Bring All Enemies",
    CurrentValue = false,
    Flag = "BringAll",
    Callback = function(v)
        bringEnabled = v
        if v then startBring()
        else
            if bringConnection then bringConnection:Disconnect() bringConnection = nil end
        end
    end
})

BringTab:CreateSlider({
    Name = "Bring Distance",
    Range = {1, 100},
    Increment = 1,
    Suffix = " studs",
    CurrentValue = 5,
    Flag = "BringDist",
    Callback = function(v) bringDistance = v end
})

BringTab:CreateParagraph({
    Title = "‚ÑπÔ∏è Info",
    Content = "Ch·ªâ bring ng∆∞·ªùi S·ªêNG.\nX√°c ch·∫øt t·ª± ·∫©n, kh√¥ng che.\nDistance 1 = s√°t m·∫∑t b·∫°n."
})

BringTab:CreateInput({
    Name = "Whitelist (d·∫•u ph·∫©y)",
    PlaceholderText = "Player1,Player2",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        whitelistNames = {}
        for name in string.gmatch(Text, "[^,]+") do
            name = string.match(name, "^%s*(.-)%s*$") or ""
            if name ~= "" then table.insert(whitelistNames, name) end
        end
        Rayfield:Notify({
            Title = "Whitelist",
            Content = #whitelistNames > 0 and table.concat(whitelistNames, ", ") or "Empty",
            Duration = 3
        })
    end
})

BringTab:CreateButton({
    Name = "Show Whitelist",
    Callback = function()
        Rayfield:Notify({
            Title = "Whitelist",
            Content = #whitelistNames > 0 and table.concat(whitelistNames, ", ") or "Empty",
            Duration = 5
        })
    end
})

BringTab:CreateButton({
    Name = "Clear Whitelist",
    Callback = function()
        whitelistNames = {}
        Rayfield:Notify({ Title = "Cleared", Content = "Whitelist empty", Duration = 3 })
    end
})

-- ========== HITBOX ==========
local HitboxTab = Window:CreateTab("üì¶ Hitbox", 4483362458)

HitboxTab:CreateToggle({
    Name = "Hitbox Expander",
    CurrentValue = false,
    Flag = "Hitbox",
    Callback = function(v)
        hitboxEnabled = v
        if v then startHitbox()
        else
            clearHitboxes()
            if hitboxConnection then hitboxConnection:Disconnect() hitboxConnection = nil end
        end
    end
})

HitboxTab:CreateSlider({
    Name = "Hitbox Size",
    Range = {10, 200},
    Increment = 5,
    Suffix = " studs",
    CurrentValue = 10,
    Flag = "HitboxSize",
    Callback = function(v) hitboxSize = v end
})

HitboxTab:CreateParagraph({
    Title = "‚ÑπÔ∏è Info",
    Content = "CH·ªà hitbox enemy S·ªêNG.\nNg∆∞·ªùi ch·∫øt ‚Üí ·∫©n ho√†n to√†n, kh√¥ng che.\nKH√îNG hitbox nh√¢n v·∫≠t b·∫°n.\nCanCollide t·∫Øt ‚Üí kh√¥ng ƒë·∫©y b·∫°n."
})

-- ========== REACH ==========
local ReachTab = Window:CreateTab("üéØ Reach", 4483362458)

ReachTab:CreateToggle({
    Name = "Infinite Reach",
    CurrentValue = false,
    Flag = "Reach",
    Callback = function(v)
        reachEnabled = v
        if v then startReach()
        else
            if reachConnection then reachConnection:Disconnect() reachConnection = nil end
        end
    end
})

ReachTab:CreateParagraph({
    Title = "‚ÑπÔ∏è Info",
    Content = "D√πng firetouchinterest.\nƒê√°nh m·ªçi enemy b·∫•t k·ªÉ kho·∫£ng c√°ch.\nKH√îNG teleport, KH√îNG lag.\nCh·ªâ hit ng∆∞·ªùi S·ªêNG.\nC·∫ßn swing weapon (b·∫≠t Auto Attack)."
})

-- ========== INFO ==========
local InfoTab = Window:CreateTab("‚ÑπÔ∏è Info", 4483362458)

InfoTab:CreateParagraph({
    Title = "Combat Suite v3",
    Content = [[
‚öîÔ∏è Attack: X hits m·ªói 0.01s
üß≤ Bring: Ch·ªâ ng∆∞·ªùi s·ªëng, x√°c ·∫©n, min 1 stud
üì¶ Hitbox: Ch·ªâ enemy s·ªëng, kh√¥ng hitbox b·∫°n
üéØ Reach: firetouchinterest, infinite range
üõ°Ô∏è Anti-fling t·ª± ƒë·ªông
üìã Whitelist cho Bring + Reach
üíÄ Auto ·∫©n x√°c ch·∫øt
    ]]
})

InfoTab:CreateButton({
    Name = "Show Players",
    Callback = function()
        local list = {}
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= LocalPlayer then
                local status = ""
                if isWhitelisted(p.Name) then status = " [WL]" end
                if not isAlive(p) then status = status .. " [DEAD]" end
                table.insert(list, p.Name .. status)
            end
        end
        Rayfield:Notify({
            Title = "Players",
            Content = #list > 0 and table.concat(list, "\n") or "None",
            Duration = 6
        })
    end
})

----------------------------------------------
-- RESPAWN HANDLER
----------------------------------------------

LocalPlayer.CharacterAdded:Connect(function(char)
    char:WaitForChild("HumanoidRootPart")
    task.wait(1.5)

    if attackEnabled then startAttack() end
    if bringEnabled then startBring() end
    if hitboxEnabled then clearHitboxes(); startHitbox() end
    if reachEnabled then startReach() end
end)

----------------------------------------------
-- ANTI-FLING + PROTECT YOUR CHARACTER
----------------------------------------------

RunService.Heartbeat:Connect(function()
    pcall(function()
        local myHRP = getHRP()
        if myHRP then
            if myHRP.AssemblyLinearVelocity.Magnitude > 80 then
                myHRP.AssemblyLinearVelocity = Vector3.zero
                myHRP.Velocity = Vector3.zero
            end
        end

        -- Lu√¥n gi·ªØ collision b·∫°n b·∫≠t
        local c = getChar()
        if c then
            for _, part in ipairs(c:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                end
            end
        end
    end)
end)

----------------------------------------------
-- INIT
----------------------------------------------

startAttack()
startDeadCleaner()

Rayfield:Notify({
    Title = "Combat Suite v3 ‚úÖ",
    Content = "Loaded! X√°c ch·∫øt t·ª± ·∫©n, hitbox ch·ªâ enemy s·ªëng.",
    Duration = 5
})
